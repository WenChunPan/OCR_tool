<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR å¤šæª”æ¡ˆè¾¨è­˜å·¥å…· | LEDA Technology</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 8px solid transparent;
            border-top: 8px solid #00eaff;
            border-radius: 50%;
            animation: loader-spin 1s linear infinite;
            box-shadow: 0 0 10px #00eaff, 0 0 20px #00eaff;
        }

        .loader-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .loader-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: #00eaff;
            font-size: 14px;
            pointer-events: none;
        }

        @keyframes loader-spin {
            0% {
                transform: rotate(0deg);
                filter: hue-rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
                filter: hue-rotate(360deg);
            }
        }

        #tableContainer {
            padding: 10px;
        }

        #log:empty {
            display: none !important;
        }

        .file-block {
            display: flex;
            gap: 16px;
            height: 85vh;
            /* é¿å…æ’è¶…éè¦–çª—ï¼Œä¿ç•™ä¸Šæ–¹æ§åˆ¶å€ */
            margin-bottom: 20px;
        }

        .preview-panel {
            flex: 1;
            max-height: 1000px;
            overflow: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f8f8;
        }

        .table-panel {
            flex: 1;
            max-height: 1000px;
            overflow: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
        }

        img,
        iframe {
            max-height: 1000px;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border: none;
        }

        .file-block img,
        .file-block iframe {
            max-width: 100%;
            max-height: 100%;
        }
    </style>



</head>

<body class="bg-gray-50 min-h-screen text-gray-800">
    <!-- Header -->
    <header class="flex items-center justify-between p-4 bg-yellow-300 shadow">
        <div class="flex items-center space-x-4">
            <img src="img/leda.jpg" alt="LEDA Logo" class="h-12">
            <h1 class="text-2xl font-bold text-gray-800 whitespace-nowrap">OCR å¤šæª”æ¡ˆè¾¨è­˜å·¥å…·</h1>
        </div>
        <p class="text-sm text-gray-700 pr-4">Powered by LEDA Technology</p>
    </header>
    <!-- File Upload Area -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <div class="mb-6">
            <input type="file" id="fileInput" multiple accept=".pdf,image/*"
                class="block w-full text-sm text-gray-600 border border-gray-300 rounded p-2">
            <button onclick="handleFiles()"
                class="mt-2 px-4 py-2 bg-yellow-400 hover:bg-yellow-500 text-white font-semibold rounded shadow">é–‹å§‹è¾¨è­˜</button>
            <p class="text-xs text-gray-500 mt-1">æ”¯æ´ä¸Šå‚³æ ¼å¼ï¼šPDF åŠåœ–ç‰‡æª”æ¡ˆ</p>
        </div>

        <!-- ç¤ºæ„å€å¡Š -->
        <div id="placeholderLayout" class="flex flex-col md:flex-row gap-4 mt-10">
            <div
                class="flex-1 border border-dashed border-gray-300 p-6 flex flex-col items-center justify-center min-h-[300px]">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">ğŸ”— åŸæª”æ¡ˆ</h2>
                <p class="text-sm text-gray-500">å¾…ä¸Šå‚³çš„å½±åƒæˆ– PDF æ–‡ä»¶</p>
            </div>
            <div
                class="flex-1 border border-dashed border-gray-300 p-6 flex flex-col items-center justify-center min-h-[300px]">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">ğŸ“„ è¾¨è­˜çµæœ</h2>
                <p class="text-sm text-gray-500">æ”¯æ´ç€è¦½å™¨å…§å³æ™‚ç·¨è¼¯</p>
            </div>
        </div>

        <!-- è™•ç†ç´€éŒ„å€ -->
        <div id="log" class="mt-6 text-sm whitespace-pre-wrap bg-white p-4 border border-gray-200 rounded shadow"></div>

        <!-- è¡¨æ ¼é¡¯ç¤ºå€ -->
        <div id="tableContainer" class="mt-4"></div>

        <!-- è¼‰å…¥ä¸­å‹•ç•« -->
        <div id="loadingSpinner"
            class="fixed top-0 left-0 w-full h-full bg-white bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="loader-wrapper">
                <div class="loader"></div>
                <div id="progressText" class="loader-text"></div>
            </div>
        </div>
    </main>
    <script>
        async function handleFiles() {
            const input = document.getElementById('fileInput');
            const files = Array.from(input.files);
            const log = document.getElementById('log');

            log.textContent = '';
            document.getElementById('placeholderLayout').style.display = 'none';
            document.getElementById('tableContainer').innerHTML = '';

            if (!files.length) {
                log.textContent = 'âš ï¸ è«‹å…ˆé¸æ“‡æª”æ¡ˆã€‚';
                return;
            }



            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('placeholderLayout').style.display = 'none';
            document.getElementById('tableContainer').innerHTML = '';
            log.textContent = '';

            for (let i = 0; i < files.length; i++) {
                document.getElementById('progressText').textContent = `${i + 1} / ${files.length}`;
                await sendToFlaskAPI(files[i], files[i].name);
            }
            document.getElementById('loadingSpinner').classList.add('hidden');
            document.getElementById('progressText').textContent = '';
        }




        async function sendToFlaskAPI(file, filename) {
            const log = document.getElementById('log');
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/ocr', {
                    method: 'POST',
                    body: formData
                });

                //if (!response.ok) {
                //     const errorText = await response.text();
                //     log.textContent += `\nâŒ éŒ¯èª¤ï¼š${response.status} - ${errorText}`;
                //     return;
                // }

                if (!response.ok) {
                    let errorTitle = "è¾¨è­˜å¤±æ•—";
                    let errorMessage = "ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";

                    try {
                        const errorData = await response.json();
                        if (errorData.error?.includes("parse OCR API response")) {
                            errorTitle = "ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼";
                            errorMessage = "è«‹ä¸Šå‚³ PDF æˆ–åœ–ç‰‡æª”æ¡ˆï¼ˆå¦‚ .jpgã€.pngï¼‰ã€‚";
                        } else if (errorData.error) {
                            errorMessage = errorData.error;
                            if (errorData.detail) {
                                errorMessage += `\nè©³ç´°è³‡è¨Šï¼š${errorData.detail}`;
                            }
                        }
                    } catch (jsonError) {
                        // è‹¥ response ä¸æ˜¯ JSONï¼ˆå¦‚ 500 éŒ¯èª¤é é¢ï¼‰ï¼Œå°±ç”¨ç´”æ–‡å­—é¡¯ç¤º
                        const fallbackText = await response.text();
                        errorMessage = `ç‹€æ…‹ç¢¼ï¼š${response.status}\n${fallbackText}`;
                    }

                    Swal.fire({
                        icon: 'error',
                        title: errorTitle,
                        text: errorMessage,
                        confirmButtonText: 'ç¢ºå®š'
                    });

                    return;
                }

                // äº¤çµ¦å‰ç«¯ä¾†åˆ¤æ–·æ˜¯å¦æœ‰è³‡æ–™
                function hasSheetData(workbook) {
                    return workbook.SheetNames.some(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        return sheetData.some(row =>
                            row.some(cell =>
                                typeof cell === 'number' || (typeof cell === 'string' && cell.trim() !== '')
                            )
                        );
                    });
                }


                const data = await response.json();
                // å–å¾—excelè¾¨è­˜çµæœ
                const base64Data = data.excel_base64;
                // å–å¾—jsonè¾¨è­˜çµæœ
                const jsonData = data.ocr_json
                const filename = file.name || 'result';

                //æŠŠExcel base64ç·¨ç¢¼è½‰æˆäºŒé€²ä½æª”æ¡ˆï¼Œè®“ä½¿ç”¨è€…å¯ä»¥ä¸‹è¼‰æˆ Excel
                const binary = atob(base64Data);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                const blob = new Blob([bytes], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });

                // è®€å– blob â†’ åˆ¤æ–· workbook æ˜¯å¦æœ‰è³‡æ–™
                const reader = new FileReader();
                reader.onload = function (e) {
                    const arrayData = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(arrayData, { type: 'array' });
                    // æ¥æ”¶å¾Œç«¯å‚³ä¾†çš„excelæ˜¯å¦æœ‰å€¼ï¼ˆtrue:æœ‰ï¼‰
                    const hasExcelData = hasSheetData(workbook);
                    console.log("ğŸ§ª å‰ç«¯å¯¦éš›åˆ¤æ–· hasExcelData:", hasExcelData);

                    // é–‹å§‹è¾¨è­˜è¡¨æ ¼oréè¡¨æ ¼
                    if (hasExcelData) {
                        const sheetNames = workbook.SheetNames;
                        const originalWorksheets = { ...workbook.Sheets };

                        const section = document.createElement('details');
                        section.open = true;
                        const summary = document.createElement('summary');
                        summary.textContent = `ğŸ“„ ${filename}`;
                        section.appendChild(summary);

                        const fileBlock = document.createElement('div');
                        fileBlock.className = 'file-block';

                        const previewPanel = document.createElement('div');
                        previewPanel.className = 'preview-panel';
                        const tablePanel = document.createElement('div');
                        tablePanel.className = 'table-panel';

                        if (file.type.startsWith('image/')) {
                            const img = document.createElement('img');
                            img.src = URL.createObjectURL(file);
                            img.className = 'max-w-full max-h-[400px] object-contain';
                            previewPanel.appendChild(img);
                        } else if (file.type === 'application/pdf') {
                            const iframe = document.createElement('iframe');
                            iframe.src = URL.createObjectURL(file);
                            iframe.className = 'w-full h-[400px]';
                            previewPanel.appendChild(iframe);
                        } else {
                            previewPanel.innerText = 'ï¼ˆä¸æ”¯æ´çš„é è¦½æ ¼å¼ï¼‰';
                        }

                        const tableDivs = [];
                        const titles = [];

                        sheetNames.forEach((sheetName, i) => {
                            const worksheet = workbook.Sheets[sheetName];
                            const tableHTML = XLSX.utils.sheet_to_html(worksheet, { editable: true });

                            const tableTitle = document.createElement('h4');
                            tableTitle.textContent = `ğŸ“‘ ${sheetName}`;
                            titles.push(tableTitle);

                            const tableDiv = document.createElement('div');
                            tableDiv.innerHTML = tableHTML;
                            tableDivs.push(tableDiv);
                        });

                        let currentPage = 0;

                        const navDiv = document.createElement('div');
                        navDiv.style.marginTop = '10px';
                        const prevBtn = document.createElement('button');
                        const nextBtn = document.createElement('button');
                        prevBtn.textContent = 'â¬…ï¸ ä¸Šä¸€é ';
                        nextBtn.textContent = 'â¡ï¸ ä¸‹ä¸€é ';
                        prevBtn.disabled = true;
                        nextBtn.disabled = sheetNames.length <= 1;

                        prevBtn.onclick = () => {
                            if (currentPage > 0) {
                                currentPage--;
                                renderPage(currentPage);
                            }
                        };
                        nextBtn.onclick = () => {
                            if (currentPage < sheetNames.length - 1) {
                                currentPage++;
                                renderPage(currentPage);
                            }
                        };

                        navDiv.appendChild(prevBtn);
                        navDiv.appendChild(nextBtn);

                        const downloadXLSXBtn = document.createElement('button');
                        downloadXLSXBtn.textContent = 'â¬‡ï¸ ä¸‹è¼‰ Excel (ä¿ç•™å¤š Sheet)';
                        downloadXLSXBtn.onclick = () => {
                            sheetNames.forEach((name, i) => {
                                const tbl = tableDivs[i].querySelector('table');
                                const updatedSheet = XLSX.utils.table_to_sheet(tbl);
                                originalWorksheets[name] = updatedSheet;
                            });
                            const newWB = XLSX.utils.book_new();
                            sheetNames.forEach(name => {
                                XLSX.utils.book_append_sheet(newWB, originalWorksheets[name], name);
                            });
                            XLSX.writeFile(newWB, filename.replace(/\.[^.]+$/, '') + '.xlsx');
                        };

                        const downloadJSONBtn = document.createElement('button');
                        downloadJSONBtn.textContent = 'â¬‡ï¸ ä¸‹è¼‰ JSON';
                        downloadJSONBtn.onclick = () => {
                            sheetNames.forEach((name, i) => {
                                const tbl = tableDivs[i].querySelector('table');
                                const updatedSheet = XLSX.utils.table_to_sheet(tbl);
                                originalWorksheets[name] = updatedSheet;
                            });
                            const result = {};
                            sheetNames.forEach(name => {
                                const sheetData = XLSX.utils.sheet_to_json(originalWorksheets[name], { header: 1 });
                                result[name] = sheetData;
                            });
                            const jsonStr = JSON.stringify(result, null, 2);
                            const blob = new Blob([jsonStr], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename.replace(/\.[^.]+$/, '') + '.json';
                            a.click();
                            URL.revokeObjectURL(url);
                        };

                        function renderPage(index) {
                            tablePanel.innerHTML = '';
                            tablePanel.appendChild(titles[index]);
                            tablePanel.appendChild(tableDivs[index]);
                            tablePanel.appendChild(navDiv);
                            tablePanel.appendChild(downloadXLSXBtn);
                            tablePanel.appendChild(downloadJSONBtn);
                            prevBtn.disabled = index === 0;
                            nextBtn.disabled = index === sheetNames.length - 1;
                        }

                        renderPage(currentPage);

                        fileBlock.appendChild(previewPanel);
                        fileBlock.appendChild(tablePanel);
                        section.appendChild(fileBlock);
                        document.getElementById('tableContainer').appendChild(section);
                        log.textContent += `\nâœ… é¡¯ç¤º ${filename} è¡¨æ ¼å®Œæˆã€‚`;
                    }
                    // éè¡¨æ ¼ï¼ˆexcelè¾¨è­˜çµæœç‚ºç©ºçš„æ™‚å€™ï¼‰ ã€Œæ²’æœ‰è¾¨è­˜å‡º Excel è¡¨æ ¼å…§å®¹ã€
                    else {
                        const section = document.createElement('details');
                        section.open = true;
                        const summary = document.createElement('summary');
                        summary.textContent = `ğŸ“„ ${filename}`;
                        section.appendChild(summary);

                        const fileBlock = document.createElement('div');
                        fileBlock.className = 'file-block';

                        const previewPanel = document.createElement('div');
                        previewPanel.className = 'preview-panel';
                        const jsonEditPanel = document.createElement('div');
                        jsonEditPanel.className = 'table-panel';

                        // å·¦é‚Šé è¦½ï¼šåœ–ç‰‡æˆ– PDF
                        const lowerName = filename.toLowerCase();
                        if (lowerName.endsWith('.jpg') || lowerName.endsWith('.jpeg') || lowerName.endsWith('.png') || lowerName.endsWith('.webp')) {
                            const img = document.createElement('img');
                            img.src = URL.createObjectURL(file);
                            img.className = 'max-w-full max-h-[400px] object-contain';
                            previewPanel.appendChild(img);
                        } else if (lowerName.endsWith('.pdf')) {
                            const iframe = document.createElement('iframe');
                            iframe.src = URL.createObjectURL(file);
                            iframe.className = 'w-full h-[400px]';
                            previewPanel.appendChild(iframe);
                        } else {
                            previewPanel.innerText = 'ï¼ˆä¸æ”¯æ´çš„é è¦½æ ¼å¼ï¼‰';
                        }

                        // âœ… å„²å­˜åŸå§‹ JSON çµæ§‹
                        const originalJson = JSON.parse(JSON.stringify(jsonData));

                        // âœ… æå–æ‰€æœ‰ text æ¬„ä½ï¼Œå«å…¶è·¯å¾‘
                        const textList = [];

                        function extractTextPaths(obj, path = []) {
                            if (typeof obj !== "object" || obj === null) return;

                            for (const key in obj) {
                                if (key === "text" && typeof obj[key] === "string") {
                                    textList.push({ path: [...path, key], value: obj[key] });
                                } else {
                                    extractTextPaths(obj[key], [...path, key]);
                                }
                            }
                        }

                        extractTextPaths(originalJson);

                        // âœ… é¡¯ç¤º text æ¬„ä½ç·¨è¼¯å€
                        const form = document.createElement('div');
                        form.style.maxHeight = '400px';
                        form.style.overflowY = 'auto';

                        textList.forEach((item, index) => {
                            const label = document.createElement('label');
                            label.textContent = `æ–‡å­—å€å¡Š ${index + 1}`;
                            label.style.fontWeight = "bold";

                            const input = document.createElement('input');
                            input.type = 'text';
                            input.value = item.value;
                            input.dataset.path = JSON.stringify(item.path);
                            input.className = "block border rounded w-full my-2 p-1 text-sm";

                            form.appendChild(label);
                            form.appendChild(input);
                        });

                        jsonEditPanel.appendChild(form);

                        // âœ… å»ºç«‹ä¸‹è¼‰æŒ‰éˆ•ï¼ˆå«ç·¨è¼¯å¾Œçš„å…§å®¹ï¼‰
                        const downloadBtn = document.createElement('button');
                        downloadBtn.textContent = 'â¬‡ï¸ ä¸‹è¼‰ JSONï¼ˆå«ç·¨è¼¯å¾Œå…§å®¹ï¼‰';
                        downloadBtn.style.marginTop = '10px';
                        downloadBtn.onclick = () => {
                            try {
                                const inputs = form.querySelectorAll('input');

                                inputs.forEach(input => {
                                    const path = JSON.parse(input.dataset.path);
                                    const newValue = input.value;

                                    // æ ¹æ“š path å›å¯«å€¼
                                    let current = originalJson;
                                    for (let i = 0; i < path.length - 1; i++) {
                                        current = current[path[i]];
                                    }
                                    current[path[path.length - 1]] = newValue;
                                });

                                const blob = new Blob([JSON.stringify(originalJson, null, 2)], { type: 'application/json' });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = filename.replace(/\.[^.]+$/, '') + '_edited.json';
                                a.click();
                                URL.revokeObjectURL(url);
                            } catch (e) {
                                alert('âŒ JSON æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•ä¸‹è¼‰ã€‚è«‹æª¢æŸ¥è¼¸å…¥å…§å®¹ã€‚');
                            }
                        };

                        jsonEditPanel.appendChild(downloadBtn);

                        // âœ… çµ„è£ç•«é¢
                        fileBlock.appendChild(previewPanel);
                        fileBlock.appendChild(jsonEditPanel);
                        section.appendChild(fileBlock);
                        document.getElementById('tableContainer').appendChild(section);
                        log.textContent += `\nâœ… é¡¯ç¤º ${filename} éè¡¨æ ¼ JSON ç·¨è¼¯å®Œæˆï¼ˆç²¾ç°¡ç‰ˆï¼‰ã€‚`;

                    }
                }
                reader.readAsArrayBuffer(blob);

            } catch (e) {
                log.textContent += `\nğŸ’¥ ç™¼ç”ŸéŒ¯èª¤ï¼š${e.message}`;
            }

        }
    </script>
</body>

</html>
